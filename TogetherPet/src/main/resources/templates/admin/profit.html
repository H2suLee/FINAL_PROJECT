<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout_admin}">

<head>
<meta charset="UTF-8">
<meta id="_csrf" name="_csrf" th:content="${_csrf.token}" />
<meta id="_csrf_header" name="_csrf_header"
	th:content="${_csrf.headerName}" />

<script
	src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script type="text/javascript"
	src="https://cdn.datatables.net/1.10.23/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" type="text/css"
	href="https://cdn.datatables.net/1.10.23/css/jquery.dataTables.min.css" />
<script
	src="https://cdn.datatables.net/buttons/1.5.1/js/dataTables.buttons.min.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/pdfmake.min.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/vfs_fonts.js"></script>
<script
	src="https://cdn.datatables.net/buttons/1.5.1/js/buttons.html5.min.js"></script>
<script
	src="https://cdn.datatables.net/buttons/1.5.1/js/buttons.print.min.js"></script>

<title>Insert title here</title>
</head>

<body>
	<article layout:fragment="content">
		<!-- Profit Card -->
		<div class="container-xxl flex-grow-1 container-p-y">
			<div class="row">
				<div class="col-xl-12">
					<div class="row">
						<div class="col-xs-6 col-sm-3">
							<div class="card">
								<div class="card-body">
									<div
										class="card-title d-flex align-items-start justify-content-between">
										<div class="avatar flex-shrink-0">
											<img src="/admin/assets/img/icons/unicons/chart-success.png"
												alt="chart success" class="rounded" />
										</div>
										<div class="dropdown">
											<button class="btn p-0" type="button" id="cardOpt3"
												data-bs-toggle="dropdown" aria-haspopup="true"
												aria-expanded="false">
												<i class="bx bx-dots-vertical-rounded"></i>
											</button>
											<div class="dropdown-menu dropdown-menu-end"
												aria-labelledby="cardOpt3">
												<a class="dropdown-item" href="javascript:void(0);">View
													More</a> <a class="dropdown-item" href="javascript:void(0);">Delete</a>
											</div>
										</div>
									</div>
									<span class="fw-semibold d-block mb-1">어제 매출 합계</span>
									<h3 class="card-title mb-2">$12,628</h3>
									<small class="text-success fw-semibold"><i
										class="bx bx-up-arrow-alt"></i> +72.80%</small>
								</div>
							</div>
						</div>
						<div class="col-xs-6 col-sm-3">
							<div class="card">
								<div class="card-body">
									<div
										class="card-title d-flex align-items-start justify-content-between">
										<div class="avatar flex-shrink-0">
											<img src="/admin/assets/img/icons/unicons/chart.png"
												alt="Credit Card" class="rounded" />
										</div>
										<div class="dropdown">
											<button class="btn p-0" type="button" id="cardOpt6"
												data-bs-toggle="dropdown" aria-haspopup="true"
												aria-expanded="false">
												<i class="bx bx-dots-vertical-rounded"></i>
											</button>
											<div class="dropdown-menu dropdown-menu-end"
												aria-labelledby="cardOpt6">
												<a class="dropdown-item" href="javascript:void(0);">View
													More</a> <a class="dropdown-item" href="javascript:void(0);">Delete</a>
											</div>
										</div>
									</div>
									<span>지난 주 매출 합계</span>
									<h3 class="card-title text-nowrap mb-1">$4,679</h3>
									<small class="text-success fw-semibold"><i
										class="bx bx-up-arrow-alt"></i> +28.42%</small>
								</div>
							</div>
						</div>
						<div class="col-xs-6 col-sm-3">
							<div class="card">
								<div class="card-body">
									<div
										class="card-title d-flex align-items-start justify-content-between">
										<div class="avatar flex-shrink-0">
											<img src="/admin/assets/img/icons/unicons/cc-success.png"
												alt="Credit Card" class="rounded" />
										</div>
										<div class="dropdown">
											<button class="btn p-0" type="button" id="cardOpt6"
												data-bs-toggle="dropdown" aria-haspopup="true"
												aria-expanded="false">
												<i class="bx bx-dots-vertical-rounded"></i>
											</button>
											<div class="dropdown-menu dropdown-menu-end"
												aria-labelledby="cardOpt6">
												<a class="dropdown-item" href="javascript:void(0);">View
													More</a> <a class="dropdown-item" href="javascript:void(0);">Delete</a>
											</div>
										</div>
									</div>
									<span>지난 달 매출 합계</span>
									<h3 class="card-title text-nowrap mb-1">$4,679</h3>
									<small class="text-success fw-semibold"><i
										class="bx bx-up-arrow-alt"></i> +28.42%</small>
								</div>
							</div>
						</div>
						<div class="col-xs-6 col-sm-3">
							<div class="card">
								<div class="card-body">
									<div
										class="card-title d-flex align-items-start justify-content-between">
										<div class="avatar flex-shrink-0">
											<img src="/admin/assets/img/icons/unicons/cc-primary.png"
												alt="chart success" class="rounded" />
										</div>
										<div class="dropdown">
											<button class="btn p-0" type="button" id="cardOpt3"
												data-bs-toggle="dropdown" aria-haspopup="true"
												aria-expanded="false"></button>
											<div class="dropdown-menu dropdown-menu-end"
												aria-labelledby="cardOpt3">
												<a class="dropdown-item" href="javascript:void(0);">View
													More</a> <a class="dropdown-item" href="javascript:void(0);">Delete</a>
											</div>
										</div>
									</div>
									<span class="fw-semibold d-block mb-1">올해 누적 매출</span>
									<div>
										<h3 class="card-title mb-2">
											<span id="totalProfit"></span>원
										</h3>
									</div>
									<small class="text-success fw-semibold"><i
										class="bx bx-up-arrow-alt"></i> +0%</small>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- /Profit Card -->
		<!-- Profit Overview -->
		<div class="row">
			<div class="col-xl-12">
				<div class="nav-align-top mb-4">
					<ul class="nav nav-pills mb-3" role="tablist">
						<li class="nav-item">
							<button type="button" class="nav-link active" role="tab"
								id="dailyBtn" data-bs-toggle="tab" data-bs-target="#dailyTab"
								aria-controls="navs-pills-top-home" aria-selected="true">
								일간</button>
						</li>
						<li class="nav-item">
							<button type="button" class="nav-link" role="tab" id="weeklyBtn"
								data-bs-toggle="tab" data-bs-target="#weeklyTab"
								aria-controls="navs-pills-top-profile" aria-selected="false">
								주간</button>
						</li>
						<li class="nav-item">
							<button type="button" class="nav-link" role="tab" id="monthlyBtn"
								data-bs-toggle="tab" data-bs-target="#monthlyTab"
								aria-controls="navs-pills-top-messages" aria-selected="false">
								월간</button>
						</li>
					</ul>
					<div class="tab-content">
						<div class="tab-pane fade show active" id="dailyTab"
							role="tabpanel">
							<div class="card h-100">
								<div class="card-body px-0">
									<div class="tab-content p-0">
										<div class="tab-pane fade show active"
											id="navs-tabs-line-card-income" role="tabpanel">
											<div class="p-4 pt-3">
												<div>
													<small class="text-muted d-block">15일 동안의 일간 차트입니다.</small>
												</div>
												<div>
													<h5 class="card-header">
														<a href="#"> << </a>&nbsp;&nbsp;&nbsp;<span id="stDay"></span>
														&nbsp;&nbsp;&nbsp;<a href="#"> >> </a>
													</h5>
												</div>
											</div>

											<div>
												<div id="dailyIncomeChart"
													style="width: 100%; height: 500px"></div>
											</div>

											<!-- Profit Table -->
											<br> <br> <br>
											<div class="daily"
												style="width: 80%; height: auto; margin: 5px auto;">
												<table id="daily" class="table">
													<thead>
														<tr>
															<th>정산일자</th>
															<th>매출(원)</th>

														</tr>
													</thead>
													<tbody>
														<tr class="days" th:each="d:${dailyList}">
															<td>[[${d.DAILY}]]</td>
															<td>[[${#numbers.formatInteger(d.PF,3,'COMMA')}]]</td>
														</tr>
													</tbody>
												</table>
											</div>

											<!-- /Profit Table -->
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="tab-pane fade" id="weeklyTab" role="tabpanel">
							<div class="card h-100">
								<div class="card-body px-0">
									<div class="tab-content p-0">
										<div class="tab-pane fade show active"
											id="navs-tabs-line-card-income" role="tabpanel">
											<div class="p-4 pt-3">
												<div>
													<small class="text-muted d-block">8주간 차트입니다.</small>
												</div>

												<div>
													<h5 class="card-header">
														<a href="#"> << </a>&nbsp;&nbsp;&nbsp;<span id="stWeek"></span>
														&nbsp;&nbsp;&nbsp;<a href="#"> >> </a>
													</h5>
												</div>
											</div>
											<div>
												<div id="weeklyIncomeChart"
													style="width: 100%; height: 500px"></div>
											</div>

											<!-- Profit Table -->
											<br> <br> <br>
											<div class="daily"
												style="width: 80%; height: auto; margin: 5px auto;">
												<table id="weekly" class="table"
													style="width: 100% !important">
													<thead>
														<tr>
															<th style="display: none">정산일자(일)</th>
															<th>정산일자(일)</th>
															<th>매출(원)</th>
														</tr>
													</thead>
													<tbody>
														<tr class="weeks" th:each="w:${weeklyList}">
															<td style="display: none">[[${w.WEEKLY}]]</td>
															<td><span>[[${w.START_DT}]]</span>&nbsp;~&nbsp;<span>[[${w.END_DT}]]</span></td>
															<td>[[${#numbers.formatInteger(w.PF,3,'COMMA')}]]</td>
														</tr>
													</tbody>
												</table>

												<!-- /Profit Table -->
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="tab-pane fade" id="monthlyTab" role="tabpanel">
							<div class="card h-100">
								<div class="card-body px-0">
									<div class="tab-content p-0">
										<div class="tab-pane fade show active"
											id="navs-tabs-line-card-income" role="tabpanel">
											<div class="p-4 pt-3">
												<div>
													<small class="text-muted d-block">6개월 동안의 월간 차트입니다.</small>
												</div>
												<div>
													<h5 class="card-header">
														<a href="#"> << </a>&nbsp;&nbsp;&nbsp;<span id="stMnth"></span>
														&nbsp;&nbsp;&nbsp;<a href="#"> >> </a>
													</h5>
												</div>
											</div>
											<div>
												<div id="monthlyIncomeChart"
													style="width: 100%; height: 500px"></div>
											</div>
											<!-- Profit Table -->
											<br> <br> <br>
											<div class="monthly" style="width: 80%; margin: 5px auto;">
												<table id="monthly" class="table">
													<thead>
														<tr>
															<th>정산일자</th>
															<th>매출(원)</th>

														</tr>
													</thead>
													<tbody>
														<tr class="mnths" th:each="m:${monthlyList}">
															<td>[[${m.MONTHLY}]]</td>
															<td>[[${#numbers.formatInteger(m.PF, 3, 'COMMA')}]]</td>
														</tr>
													</tbody>
												</table>
											</div>

											<!-- /Profit Table -->
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

		</div>
		<!--/ Profit Overview -->
		<script type="text/javascript"
			src="https://www.gstatic.com/charts/loader.js"></script>
		<script type="text/javascript">
			/* <div id="curve_chart" style="width: 100%; height: 500px"></div> */
			
		$('#weeklyBtn').on('click', function() {
			chartId = 'weeklyIncomeChart';
			arrs = weeklyChart();	
			google.charts.setOnLoadCallback(drawChart);
			})	
			
		$('#monthlyBtn').on('click', function() {
			chartId = 'monthlyIncomeChart';
			arrs = monthlyChart();	
			google.charts.setOnLoadCallback(drawChart);
			})
	
		$('#dailyBtn').on('click', function() {
			chartId = 'dailyIncomeChart';
			arrs = dailyChart();	
			google.charts.setOnLoadCallback(drawChart);
			})	
			
			
		// 올해 몇주차인지 반환 ( ex 39주 )	
		function ISO8601_week_no() 
		  {
			 var dt = new Date();	
		     var tdt = new Date(dt.valueOf());
		     var dayn = (dt.getDay() + 6) % 7;
		     tdt.setDate(tdt.getDate() - dayn + 3);
		     var firstThursday = tdt.valueOf();
		     tdt.setMonth(0, 1);
		     if (tdt.getDay() !== 4) 
		       {
		      tdt.setMonth(0, 1 + ((4 - tdt.getDay()) + 7) % 7);
		        }
		     return 1 + Math.ceil((firstThursday - tdt) / 604800000);
		        }

		function weeklyChart(){
				arrs = [];
				let f = ['Weekly', 'Profit'];
				arrs.push(f);
				
				let weekNo = ISO8601_week_no();
				let weeks = $('.weeks');
				$('#stWeek').html(weekNo + '주차')
				
				for(i=weekNo-8; i<=weekNo; i++){
					let arr = [];
													
					arr[0] = i + "주";
					for(week of weeks){
						let w = Number(week.children[0].innerHTML);
						let p = Number(week.children[2].innerHTML.replace(",",""));
						if(w==i){
							console.log('같습니다.')
							arr[1] = p;
							break;
						}else{
							arr[1] = 0;
						}
					}
					console.log('arr', arr);
					arrs.push(arr);
				}
				return arrs;
			};
			
		function monthlyChart(){
				arrs = [];
				let f = ['Monthly', 'Profit'];
				arrs.push(f);
				
				let today = new Date();
				let month = Number(today.toISOString().substr(5,2));
				$('#stMnth').html(today.toISOString().substr(0,7))
				//console.log('month', month	);
				//console.log(typeof month);
				
				let mnths = $('.mnths');
				
				//console.log('mnths', mnths);
				for(i=month-6; i<=month; i++){
					let arr = [];
					arr[0] = i + "월";
					//console.log('i', i);
					for(mnth of mnths){
						//console.log('mnth', mnth);
						let m = mnth.children[0].innerHTML;
						m = Number(m.substr(0,2));
						let p = Number(mnth.children[1].innerHTML.replace(",",""));
						//console.log('m', m);
						//console.log('p', p);
						
						if(m==i){
							//console.log('같습니다.')
							arr[1] = p;
							break;
						}else{
							arr[1] = 0;
						}
					}
					//console.log('arr', arr);
					arrs.push(arr);
				}
				//console.log('ars', arrs);
				return arrs;
			}
			
		function dailyChart(){
			let arrs = [];
			let f = ['Daily', 'Profit'];
			arrs.push(f);
		
			let today = new Date();
			//today = new Date(today.setMonth(today.getMonth() - 1));
			$('#stDay').html(today.toISOString().substr(0,10))
			today = new Date(Date.parse(today) - 15 * 1000 * 60 * 60 * 24); // 보름 전
		
			let days = $('.days');
			
				for(i=0; i<15; i++){
					today.setDate(today.getDate()+1);
					t = today.toISOString().substr(0, 10);
					let arr = [];
					console.log('t', t);
					arr[0] = t.substr(5);
					for(day of days){
						
						let d = day.children[0].innerHTML;
						let p = Number(day.children[1].innerHTML.replace(",",""));
						if(d==t){
							arr[1] = p;
							break;
						}else{
							arr[1] = 0;
						}
					}
					arrs.push(arr);
				}
				return arrs;
			}
			
			/* total profit */
			let pfSum = $('.mnths');
			let sum = 0;
			for(pf of pfSum){
				let p = Number(pf.children[1].innerHTML.replace(",",""));
				sum += p;
			}
			
			$('#totalProfit').html(sum.toLocaleString())
			
			/* Google Chart */

			let arrs = [];
			arrs = dailyChart();
			
			let chartId='dailyIncomeChart';
			
			google.charts.load('current', {
				'packages' : [ 'corechart' ]
			});
			google.charts.setOnLoadCallback(drawChart);

			function drawChart() {
				console.log('>>>', arrs);
				var data = google.visualization.arrayToDataTable(arrs);
				
				var options = {
					title : 'Company Performance',
					curveType : 'function',
					legend : {
						position : 'bottom'
					},
					 vAxis: {
	                    min: 0
	                }
				};
				console.log('chartID', chartId)
				
				var chart = new google.visualization.LineChart(document
						.getElementById(chartId));

				chart.draw(data, options);
			}
			
			/* DataTables */

			$('#daily').DataTable({
				lengthChange : false,
				pageLength : 10,
				lengthMenu : [ 10, 20, 30, 40, 50 ],
				info : true,
				searching : false,
				ordering : false,
			});
			$('#weekly').DataTable({
				lengthChange : false,
				pageLength : 10,
				lengthMenu : [ 10, 20, 30, 40, 50 ],
				info : true,
				searching : false,
				ordering : false,
			});
			$('#monthly').DataTable({
				lengthChange : false,
				pageLength : 10,
				lengthMenu : [ 10, 20, 30, 40, 50 ],
				info : true,
				searching : false,
				ordering : false,
			});
			
			/* 올해 n주차의 시작날짜(일요일) 구하기 */
			var month_days       = new Array( 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31 );
			var month_days_count = new Array();

			// 윤년(2월이 29일)인지 검사
			function is_leap_year( year )
			{
			    return ( year % 4 == 0 && year % 100 != 0 ) || ( year % 400 == 0 && year % 4000 != 0 );
			}

			// 년도에 맞게 month_days 와 month_days_count의 값을 설정한다.
			function set_month_days( year )
			{
			        if( is_leap_year( year ) ) month_days[1] = 29; else month_days[1] = 28;

			        month_days_count[0] = 0;

			        for( i=0;i<12;i++){
			                month_days_count[i+1] = month_days_count[i] + month_days[i];
			        }
			}
			console.log(test('2022', 40));
			function test(year, week)
			{
			        set_month_days( year );

			        var weekday = new Date( year,0,1).getDay();
			        var total_days = ( (week-1) * 7 ) - weekday;
			        
			        var yy1,yy2,mm1,mm2,dd1,dd2;

			        if( total_days < 0 ){
			                yy1 = year-1;
			                yy2 = year;
			                mm1=12;
			                mm2=1;
			                dd1=32-weekday;
			                dd2=7-weekday;
			        }else{
			            yy1 = yy2 = year;
			                for( mm1 = 0 ; mm1 < 12 ; mm1++ ){
			                        if( month_days_count[mm1] > total_days ) break;
			                }
			                
			                dd1 = total_days - month_days_count[mm1-1] + 1;        
			                dd2 = dd1 + 6;
			                mm2 = mm1;

			                if( dd2 > month_days[ mm1-1 ] ){
			                        mm2 = mm1 % 12 + 1;
			                        dd2 = dd2 - month_days[ mm1-1];
			                }

			                if( mm1==12 && mm2==1 ) yy2++;  
			        }
			        
			        var ss0 =  year + "년 " + week  + "주"
			        var ss1 =  yy1 + "년 " + mm1 + "월 " + dd1 + "일";
			        var ss2 =  yy2 + "년 " + mm2 + "월 " + dd2 + "일";        

			        return ss1;       
			}
			
		</script>
	</article>
</body>
</html>