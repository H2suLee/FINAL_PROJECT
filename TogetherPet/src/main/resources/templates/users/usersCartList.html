<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout_mypage}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
	href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
	rel="stylesheet" />

<!-- Vendors CSS -->
<link rel="stylesheet"
	href="/admin/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />

<!-- Helpers -->
<script src="/admin/assets/vendor/js/helpers.js"></script>

<!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
<!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
<script src="/admin/assets/js/config.js"></script>
<script>
		document.addEventListener('DOMContentLoaded', function () {
			// 총액 계산
			getTotal();

			function getTotal() {

				//subtotal
				let total = $('.sTotal')
				let sTotal = 0;
				for (t of total) {
					sTotal += Number(t.innerHTML);
				}
				// 천단위 콤마
				sTotal = sTotal.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");
				$('#sTotal').html(sTotal)

				//grandtotal 할인 적용 후 
				total = $('.gTotal')
				let gTotal = 0;
				for (t of total) {
					gTotal += Number(t.innerHTML);
				}
				//천단위 콤마
				gTotal = gTotal.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");
				$('#gTotal').html(gTotal)
			}

			// 장바구니 삭제	
			$('.remove').on('click', '.removeCart', function () {
				let cartNo = $(this).closest('tr').attr('id')
				$.ajax({
						url: 'ajaxCartDelete',
						type: 'post',
						data: {
							cartNo: cartNo
						}
					})
					.done(res => {
						alert(res);
						document.getElementById(cartNo).remove();
						getTotal();
					})
			})
			// 장바구니 수량 업데이트
			$('.update').on('change', '.updateCart', function () {
				//alert($(this).closest('tr').attr('id'))
				let cartNo = $(this).closest('tr').attr('id');
				let tr = document.getElementById(cartNo);
				let qty = Number(tr.children[3].children[0].children[0].value)
				let dc = Number(tr.children[5].children[0].innerHTML)
				let price = Number(tr.children[2].children[0].children[0].innerText)

				$.ajax({
						url: 'ajaxCartUpdate',
						type: 'post',
						data: {
							cartNo: cartNo,
							qty: qty
						}
					})
					.done(res => {
						if (res == "1") {
							// 수량 * 단가 동적 계산
							tr.children[4].children[0].children[0].innerText = qty * price
							tr.children[4].children[0].children[1].innerText = qty * price * (1 - dc);

							getTotal();
						}
					})
			})
			// order로 이동
			$('#orderCallBtn').on('click', function () {
				if (confirm('주문 페이지로 넘어가시겠습니까?')) {
					// userNo
					let uN = $('.cart_product_text')[0];
					uN = Number(uN.children[0].innerHTML);

					userNo.value = uN;
					document.getElementById('orderCall').submit();
				}
			})
		})
	</script>


</head>
<body>
	<div class="col-lg-10 col-md-12" layout:fragment="content">
		<!--shop wrapper start-->
		<!-- Content wrapper -->
		<div class="content-wrapper">
			<!-- Content -->
			<div class="container-xxl flex-grow-1 container-p-y">
				<!--breadcrumbs area start-->
				<div class="breadcrumb_content">
					<ul>
						<li><a href="/">home</a></li>
						<li>my page</li>
						<li>장바구니</li>
					</ul>
				</div>
				<!--breadcrumbs area end-->

				<div class="shipping_text">
					<h3>장바구니</h3>
				</div>
				<br>

				<!-- Hoverable Table rows -->
				<div class="card">
					<div class="table-responsive text-nowrap">
						<table class="table table-hover">
							<thead>
								<tr>
									<th>상품이미지</th>
									<th>상품명</th>
									<th>수량</th>
									<th>가격</th>
									<th>총 금액</th>
									<th style="display: none"></th>
								</tr>
							</thead>
							<tbody class="table-border-bottom-0">
								<tr th:each="list:${cartList}" class="border-top"
									th:id="${list.cartNo}">
									<td>
										<div class="cart_product_thumb">
											<img src="/assets/img/product/product4.jpg" alt="">
										</div>
									</td>
									<td>
										<div class="cart_product_text">
											<h4 style="display: none" th:text="${list.name}"></h4>
											<h4>[[${list.name}]]</h4>
										</div>
									</td>
									<td>
										<div class="cart_product_quantity update">
											<input min="1" max="100" th:value="${list.qty}" type="number"
												class="updateCart">
										</div>
									</td>
									<td>
										<div class="cart_product_price">
											<span>[[${#numbers.formatInteger(list.price*(1-c.dc),4)}]]</span>
										</div>
									</td>
									<td>
										<div class="cart_product_price">
											<span class="gTotal">[[${#numbers.formatInteger(list.price*(1-c.dc)*c.qty,4)}]]</span>
											<span class="sTotal" style="display: none">[[${list.price*c.qty}]]</span>
										</div>
									</td>
									<td>
										<div class="dropdown">
											<button type="button"
												class="btn p-0 dropdown-toggle hide-arrow"
												data-bs-toggle="dropdown"></button>
											<div class="dropdown-menu">
												<a class="dropdown-item" href="javascript:void(0);"> <i
													class="bx bx-edit-alt me-1"></i> Edit
												</a> <a class="dropdown-item" href="javascript:void(0);"> <i
													class="bx bx-trash me-1"></i> Delete
												</a>
											</div>
										</div>
									</td>
									<td style="display: none"><span>[[${list.dc}]]</span></td>
									<td>
										<div class="cart_product_remove text-right remove">
											<a class="removeCart"> <i class="ion-android-close"></i>
											</a>
										</div>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
				<!--/ Hoverable Table rows -->

				<div class="col-lg-12 col-md-12 col-sm-12">
					<div class="grand_totall_area">
						<div class="grand_totall_inner border-bottom">
							<div class="cart_subtotal d-flex justify-content-between">
								<p>할인 전 총액</p>
								<span id="sTotal"></span>
							</div>
							<div class="cart_grandtotal d-flex justify-content-between">
								<p>할인 후 총액</p>
								<span id="gTotal"></span>
							</div>
						</div>

						<div align="center">
							<a class="btn btn-primary" id="orderCallBtn">주문 및 결제하기</a>&nbsp;
							<a class="btn btn-primary" href="shop">계속 쇼핑하기</a>
						</div>
					</div>
				</div>

			</div>
			<!-- / Content -->

			<div class="content-backdrop fade"></div>
		</div>
		<!-- Content wrapper -->


		<!--shop wrapper end-->
	</div>
	<!--shop  area end-->
</body>
</html>